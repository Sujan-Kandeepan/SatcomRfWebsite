
@{
    ViewBag.Title = "Calibration";
}

<style>
    #data-display, #data-table {
        width: 100%;
        max-height: 500px;
        overflow-x: auto;
    }

    th, td {
        text-align: center;
        white-space: nowrap;
    }

    table th:nth-child(n), td:nth-child(n) {
        border-left: 1px solid lightgrey;
    }

    table th:first-child, td:first-child {
        border: none;
    }
</style>

<script>
    function setURL(value) {
        if (value == "default") {
            location.href = location.origin + "/Calibration";
        } else {
            location.href = location.origin + "/Calibration/Index/" + value.replace(" ", "");
        }
    }

    function create(value) {
        if (value == "default") {
            location.href = location.origin + "/Calibration/Create";
        } else {
            location.href = location.origin + "/Calibration/Create/" + value.replace(" ", "");
        }
    }

    function getData(assetNumber) {
        if (assetNumber != "default") {
            $.ajax({
                type: "post",
                url: "/Calibration/GetData",
                data: { "type": $("#cal-type").val(), "assetNumber": assetNumber },
                dataType: "text",
                success: function (result) {
                    var data = JSON.parse(result);
                    console.log(data);
                    var html = "<table class='table table-striped' id='data-table'><tr><thead><th" + ($("#cal-type").val() != "Power Sensor" ? " rowspan='2' style='vertical-align: middle'" : "") + ">Frequency</th>";
                    for (var i = 0; i < data.dates.length; i++) {
                        html += "<th" + ($("#cal-type").val() != "Power Sensor" ? " colspan='2'" : "") + ">" + data.dates[i] + "</th>";
                    }
                    if ($("#cal-type").val() != "Power Sensor") {
                        html += "</tr><tr>";
                        for (var i = 0; i < data.dates.length; i++) {
                            html += "<th>Cal Factor</th><th>Return Loss</th>";
                        }
                    }
                    html += "</tr></thead><tbody>";
                    for (var i = 0; i < data.freqs.length; i++) {
                        html += "<tr><td><em>" + data.freqs[i] + "</em></td>";
                        for (var j = 0; j < data.dates.length; j++) {
                            html += "<td" + ($("#cal-type").val() == "Power Sensor" ? "" : "") + ">" + data.calFactor[j][i] + "</td>";
                            if ($("#cal-type").val() != "Power Sensor") {
                                html += "<td>" + data.returnLoss[j][i] + "</td>";
                            }
                        }
                        html += "</tr>";
                    }
                    html += "</tbody></table>";

                    $("#data-display").html(html);
                    $("#separator").show();
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                }
            });
        } else {
            $("#data-display").html("");
            $("#separator").hide();
        }
        
    }

    $(document).ready(function () {
        $.ajax({
            type: "post",
            url: "/Calibration/GetAssetNumbers",
            data: { "type": $("#cal-type").val() },
            dataType: "text",
            success: function (result) {
                var assetNumbers = JSON.parse(result);
                var html = '<option value="default">@(Request.Url.ToString().Replace("/", "").EndsWith("Calibration") ? "" : "Select an asset number" )</option>';
                for (var i = 0; i < assetNumbers.length; i++) {
                    html += '<option value="' + assetNumbers[i] + '">' + assetNumbers[i] + '</option>';
                }
                $("#asset-numbers").html(html);
            },
            error: function (xhr, status, error) {
                alert(xhr.responseText);
            }
        });

        getData($("#asset-numbers").val() || "default");

        $('#data-table').dataTable({
            "scrollX": 1200
        });
    });
</script>

<div class="page-header"><h1>Calibration Data Overview</h1></div>
<div class="row">
    <div class="col-md-4" style="margin-top: -20px">
        <div class="display">
            <h3>View calibration data with history.</h3>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-control" id="cal-type" onchange="setURL(this.value)">
            <option value="default">Select a device type</option>
            <option value="Attenuator" @(Request.Url.ToString().Contains("Attenuator") ? "selected" : "" )>Attenuator</option>
            <option value="Output Coupler" @(Request.Url.ToString().Contains("OutputCoupler") ? "selected" : "" )>Output Coupler</option>
            <option value="Power Sensor" @(Request.Url.ToString().Contains("PowerSensor") ? "selected" : "" )>Power Sensor</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-control" id="asset-numbers" @(Request.Url.ToString().Replace("/", "").EndsWith("Calibration") ? "disabled" : "" ) onchange="getData(this.value)"></select>
    </div>
    <div class="col-md-2">
        <a class="form-control btn btn-primary" id="create" onclick="create($('#cal-type').val())">Submit new record</a>
    </div>
</div>

<hr id="separator" />

<div id="data-display"></div>