@model SatcomRfWebsite.Models.CalibrationData

@{
    ViewBag.Title = "Create";
}

@Scripts.Render("~/bundles/js/Calibration")

<div class="page-header"><h1>Submit Calibration Data</h1></div>
<div class="row">
    <div class="col-md-6" style="margin-top: -20px">
        <div class="display">
            <h3>Submit new calibration record to database.</h3>
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-control" id="cal-type" onchange="setURL(this.value)">
            <option value="default">Select a device type</option>
            <option value="Attenuator" @(Request.Url.ToString().Contains("Attenuator") ? "selected" : "" )>Attenuator</option>
            <option value="Output Coupler" @(Request.Url.ToString().Contains("OutputCoupler") ? "selected" : "" )>Output Coupler</option>
            <option value="Power Sensor" @(Request.Url.ToString().Contains("PowerSensor") ? "selected" : "" )>Power Sensor</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-control btn btn-info @(Request.Url.ToString().Replace("/", "").EndsWith("Create") ? "disabled" : "" )" id="import-file">Import calibration file<input type="file" style="display: none;"></label>
    </div>
</div>

@using (Html.BeginForm())
{
    if (Request.Url.ToString().Contains("Attenuator"))
    {
        @Html.Partial("ATCalForm")
    }

    if (Request.Url.ToString().Contains("OutputCoupler"))
    {
        @Html.Partial("OCCalForm")
    }

    if (Request.Url.ToString().Contains("PowerSensor"))
    {
        @Html.Partial("PSCalForm")
    }
}

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://terrylinooo.github.io/jquery.disableAutoFill/assets/js/jquery.disableAutoFill.min.js"></script>
<script>
    $(document).ready(function () {
        $('form').disableAutoFill();

        $(".datepicker").datepicker({
            format: 'mm/dd/yyyy',
            changeMonth: true,
            changeYear: true
        });

        $("input:text,form").click(function () {
            $(this).attr("autocomplete", "off");
        });

        $("input:file").on("change", function () {
            if ($(this).prop("files").length > 0 && window.FormData !== undefined) {
                var file = $(this).prop("files")[0];
                var data = new FormData();
                data.append('file', file);

                $.ajax({
                    type: "post",
                    url: "/Calibration/ImportFile",
                    data: data,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        alert(result);
                    },
                    error: function (xhr, status, p3, p4) {
                        var err = "Error " + " " + status + " " + p3 + " " + p4;
                        if (xhr.responseText && xhr.responseText[0] == "{")
                            err = JSON.parse(xhr.responseText).Message;
                        alert(err);
                    }
                });
            } else {
                alert("This browser does not support file uploads!");
            }
            $(this).val("");
        });

        $("#Points").on("input change", function() {
            if ($("#Points").val().length > 3) {
                $("#Points").val($("#Points").val().substring(0, 3));
            }

            $.ajax({
                type: "post",
                url: "/Calibration/CreateDataFields",
                data: { "num": $("#Points").val() > 0 ? $("#Points").val() : 0, "returnloss": document.URL.indexOf("PowerSensor") == -1 ? true : false },
                dataType: "text",
                success: function (result) {
                    $("#DataFields").html(result);
                },
                error: function(xhr, status, error) {
                    $("#DataFields").html(xhr.responseText);
                }
            });
        });
    });
</script>