
@{
    ViewBag.Title = "Edit";
}

<div class="page-header row" style="border-bottom: none; margin-bottom: -15px">
    <div class="row">
        <div class="col-lg-8">
            <h1 id="title">Edit...</h1>
        </div>
        <div class="col-lg-2" style="margin-top: 30px">
            <button class="btn btn-warning btn-block" id="reset">Reset changes</button>
        </div>
        <div class="col-lg-2" style="margin-top: 30px">
            <button class="btn btn-primary btn-block" id="details">Back to details</button>
        </div>
    </div>
</div>

<div class="alert alert-warning" id="assetnum-not-recognized" style="margin: 10px 0 0 0" hidden>
    <strong>Asset number not recognized!</strong>
    By submitting this form, you will be creating a new asset number record in the database.
    Please use proper naming conventions and letter casing.
</div>

@using (Html.BeginForm())
{
    <div id="params" hidden>
        <input type="text" class="form-control" id="TypePassed" name="TypePassed" />
        <input type="text" class="form-control" id="AssetNumberPassed" name="AssetNumberPassed" />
        <input type="text" class="form-control" id="DatePassed" name="DatePassed" />
    </div>

    if (Request.Url.ToString().Contains("Attenuator"))
    {
        @Html.Partial("ATCalForm")
    }

    if (Request.Url.ToString().Contains("OutputCoupler"))
    {
        @Html.Partial("OCCalForm")
    }

    if (Request.Url.ToString().Contains("PowerSensor"))
    {
        @Html.Partial("PSCalForm")
    }
}

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://terrylinooo.github.io/jquery.disableAutoFill/assets/js/jquery.disableAutoFill.min.js"></script>
<script>
    var type = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
    var assetnum = document.URL.substring(document.URL.indexOf("assetnum=") + 9, document.URL.indexOf("date=") - 1).split('_').join(' ');
    var date = document.URL.substring(document.URL.indexOf("date=") + 5);

    $("#TypePassed").val(type);
    $("#AssetNumberPassed").val(assetnum);
    $("#DatePassed").val(date);

    function fillForm() {
        $.ajax({
            type: "post",
            url: "/Calibration/GetDetails",
            data: { "type": type, "assetnum": assetnum, "date": date },
            datatype: "json",
            success: function (result) {
                if (result == "Fail") {
                    alert("Could not retrieve existing data!");
                    return;
                }

                var headers = JSON.parse(result.headers);
                if (type == "Attenuator" || type == "OutputCoupler") {
                    $("#AssetNumber").val(headers.AssetNumber);
                    $("#Operator").val(headers.Operator);
                    $("#CalDate").val(headers.CalDate);
                    $("#StartFreq").val(headers.StartFreq);
                    $("#StopFreq").val(headers.StopFreq);
                    $("#ExpireDate").val(headers.ExpireDate);
                    $("#Loss").val(headers.Loss);
                    $("#Power").val(headers.Power);
                    $("#MaxOffset").val(headers.MaxOffset);
                    $("#Temp").val(headers.Temp);
                    $("#Humidity").val(headers.Humidity);
                    $("#Lookback").val(headers.Lookback);
                    $("#Points").val(result.freqs.length);
                } else if (type == "PowerSensor") {
                    var dateReturned = headers.CalDate.substring(0, headers.CalDate.indexOf("T"));
                    var pieces = dateReturned.split('-');
                    var date = pieces[1] + "/" + pieces[2] + "/" + pieces[0];

                    $("#AssetNumber").val(headers.AssetNumber);
                    $("#Operator").val(headers.Operator);
                    $("#CalDate").val(headers.CalDate);
                    $("#Series").val(headers.Series);
                    $("#Serial").val(headers.Serial);
                    $("#RefCal").val(headers.RefCal);
                    $("#Certificate").val(headers.Certificate);
                    $("#Points").val(result.freqs.length);
                }

                var freqs = [], calFactor = [], returnLoss = [];
                for (var i = 0; i < $("#DataFields > .row").length; i++) {
                    freqs.push($("#Records_" + i.toString() + "__Frequency").val());
                    calFactor.push($("#Records_" + i.toString() + "__CalFactor").val());
                    returnLoss.push($("#Records_" + i.toString() + "__ReturnLoss").val());
                }

                $.ajax({
                    type: "post",
                    url: "/Calibration/CreateDataFields",
                    data: {
                        "num": $("#Points").val() > 0 ? $("#Points").val() : 0,
                        "hasReturnLoss": document.URL.indexOf("PowerSensor") == -1 ? true : false,
                        "freqs": JSON.stringify(freqs),
                        "calFactor": JSON.stringify(calFactor),
                        "returnLoss": JSON.stringify(returnLoss)
                    },
                    dataType: "text",
                    success: function (result2) {
                        $("#DataFields").html(result2);
                        $("form input").prop("disabled", false);

                        setTimeout(function () {
                            for (var i = 0; i < result.freqs.length; i++) {
                                $("#Records_" + i.toString() + "__Frequency").val(result.freqs[i].toString());
                                $("#Records_" + i.toString() + "__CalFactor").val(result.calFactor[i].toString());
                                $("#Records_" + i.toString() + "__ReturnLoss").val(result.returnLoss[i].toString());
                            }
                        }, 0);
                    },
                    error: function (xhr, status, error) {
                        $("#DataFields").html(xhr.responseText);
                        $("form input").prop("disabled", false);
                    }
                });
            },
            error: function (xhr, status, p3, p4) {
                $("form input").prop("disabled", false);

                var err = "Error " + " " + status + " " + p3 + " " + p4;
                if (xhr.responseText && xhr.responseText[0] == "{")
                    err = JSON.parse(xhr.responseText).Message;
                console.log(err);
            }
        });
    }

    $(document).ready(function () {
        $('form').disableAutoFill();
        $("form input").prop("disabled", true);

        document.getElementById("navBarCalibration").classList.add("active");

        $(".datepicker").datepicker({
            format: 'mm/dd/yyyy',
            changeMonth: true,
            changeYear: true
        });

        $("#title").html("Edit " + assetnum + " (" + date + ")");

        fillForm();

        $("#reset").click(function () {
            $("#DataFields").html('<span style="color: grey">Form fields to enter calfactor records will appear here</span>');
            fillForm();
        });

        $("#details").click(function () {
            location.href = document.URL.replace("Edit", "Details");
        });

        $("input:text,form").click(function () {
            $(this).attr("autocomplete", "off");
        });

        $.ajax({
            type: "post",
            url: "/Calibration/GetAssetNumbers",
            data: {
                "type": type
            },
            dataType: "text",
            success: function (result) {
                $("#AssetNumber").autocomplete({
                    source: JSON.parse(result),
                    minLength: 0,
                    close: function (event, ui) {
                        $("#assetnum-not-recognized").hide();
                    }
                }).focusout(function () {
                    if (JSON.parse(result).indexOf($("#AssetNumber").val()) == -1 && $("#AssetNumber").val() != "") {
                        setTimeout(function() { $("#assetnum-not-recognized").show(); }, 0);
                    } else {
                        $("#assetnum-not-recognized").hide();
                    }
                });
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
            }
        });

        $("#Points").on("input change", function () {
            if ($("#Points").val().length > 3) {
                $("#Points").val($("#Points").val().substring(0, 3));
            }

            var freqs = [], calFactor = [], returnLoss = [];
            for (var i = 0; i < $("#DataFields > .row").length; i++) {
                freqs.push($("#Records_" + i.toString() + "__Frequency").val());
                calFactor.push($("#Records_" + i.toString() + "__CalFactor").val());
                returnLoss.push($("#Records_" + i.toString() + "__ReturnLoss").val());
            }

            $.ajax({
                type: "post",
                url: "/Calibration/CreateDataFields",
                data: {
                    "num": $("#Points").val() > 0 ? $("#Points").val() : 0,
                    "hasReturnLoss": document.URL.indexOf("PowerSensor") == -1 ? true : false,
                    "freqs": JSON.stringify(freqs),
                    "calFactor": JSON.stringify(calFactor),
                    "returnLoss": JSON.stringify(returnLoss)
                },
                dataType: "text",
                success: function (result) {
                    $("#DataFields").html(result);
                },
                error: function (xhr, status, error) {
                    $("#DataFields").html(xhr.responseText);
                }
            });
        });
    });
</script>